---
import { humanize, slugifyTitle } from "@/lib/utils/textConverter";

// ç¡®ä¿æ‰€æœ‰propséƒ½æœ‰é»˜è®¤å€¼
const { tags = [], category = [], allCategories = [] } = Astro.props; 

// ðŸš€ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½å¤„ç† category æ•°æ®æ ¼å¼
const processCategories = () => {
  if (!category || category.length === 0) return [];
  
  // æƒ…å†µ1ï¼šå·²ç»æ˜¯å­—ç¬¦ä¸²æ•°ç»„ ["åŠ¨æ¼«", "è§‚å½±æŒ‡å—"]
  if (typeof category[0] === 'string') {
    return category.map(cat => ({
      name: cat,
      slug: slugifyTitle(cat)
    }));
  }
  
  // æƒ…å†µ2ï¼šå¯¹è±¡æ•°ç»„ [{name: "...", count: 0}]
  if (typeof category[0] === 'object' && category[0].name) {
    return category.map(item => ({
      name: item.name,
      slug: slugifyTitle(item.name)
    }));
  }
  
  return [];
};

// ðŸš€ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½è®¡ç®—åˆ†ç±»æ•°é‡
const calculateCategoryCounts = () => {
  const counts = {};
  const processedCats = processCategories();
  
  if (processedCats.length === 0) return counts;
  
  // ä½¿ç”¨ allCategories æˆ–å½“å‰ categories æ¥è®¡ç®—
  const sourceForCounting = allCategories.length > 0 ? allCategories : processedCats.map(c => c.name);
  
  sourceForCounting.forEach(cat => {
    counts[cat] = (counts[cat] || 0) + 1;
  });
  
  return counts;
};

const processedCategories = processCategories();
const categoryCounts = calculateCategoryCounts();
---

<div class="lg:col-4">
  <div class="mb-8">
    <h5 class="mb-6">åˆ†ç±»</h5>
    <div class="rounded bg-light p-8 dark:bg-darkmode-light">
      <ul class="space-y-4">
        {
          processedCategories.length > 0 && processedCategories.map((cat) => { 
            const count = categoryCounts[cat.name] || 0;
            return (
              <li>
                <a
                  class="flex justify-between hover:text-primary dark:hover:text-darkmode-primary"
                  href={`/categories/${cat.slug}`}
                >
                  {humanize(cat.name)} <span>({count})</span>
                </a>
              </li>
            );
          })
        }
        {
          processedCategories.length === 0 && (
            <li class="text-text-light dark:text-darkmode-text-light">
              æš‚æ— åˆ†ç±»
            </li>
          )
        }
      </ul>
    </div>
  </div>
  
  <div class="mb-8">
    <h5 class="mb-6">æ ‡ç­¾</h5>
    <div class="rounded bg-light p-6 dark:bg-darkmode-light">
      <ul>
        {
          tags.length > 0 && tags.map((tag: string) => {
            return (
              <li class="inline-block">
                <a
                  class="m-1 block rounded bg-white px-3 py-1 hover:bg-primary hover:text-white dark:bg-darkmode-body dark:hover:bg-darkmode-primary dark:hover:text-text-dark"
                  href={`/tags/${slugifyTitle(tag)}`}
                >
                  {humanize(tag)}
                </a>
              </li>
            );
          })
        }
        {
          tags.length === 0 && (
            <li class="text-text-light dark:text-darkmode-text-light">
              æš‚æ— æ ‡ç­¾
            </li>
          )
        }
      </ul>
    </div>
  </div>
</div>